#!/usr/bin/env ruby

require 'basis-band'
require 'optparse'

def samples_to_csv(samples)
  lines = []
  cols = samples.first.keys
  lines << cols.join(',')
  samples.each do |s|
    lines << cols.map{|c| s[c]}.join(",")
  end
  lines
end

options = {}

OptionParser.new do |opts|
  opts.banner = "basis-band gem v#{BasisBandMeta::VERSION}\nUsage: basis-band [options]"
  opts.on("-u", "--userid USERID", "User ID from mybasis.com") do |u|
    options[:userid] = u
  end
  opts.on("-d", "--date DATE", "Date to fetch from mybasis.com") do |d|
    options[:date] = d
  end
  opts.on("-c", "--[no-]csv", "Output CSV format") do |c|
    options[:csv] = c
  end
  opts.on("-C", "--cachedir DIR", "Directory to use to cache results") do |c|
    options[:cachedir] = c
  end
  opts.on("-l", "--login username:password", "Login and print user id") do |l|
    options[:login] = l
  end
  opts.on("-s", "--summary", "Summarize all the data from the cache") do |s|
    options[:summary] = s
  end
  opts.on("-t", "--token TOKEN", "Token for v2 API access") do |t|
    options[:token] = t
  end
end.parse!

if options[:login]
  (u,p) = options[:login].split(":", 2)
  token, id = ApiAuth.new.login(u, p)
  puts "ID for V1 api: #{id}"
  puts "token for V2 api: #{token}"
  exit
end

b = BasisBand.new(options[:userid])
if options[:cachedir]
  b.set_cache_dir(options[:cachedir])
end

if options[:summary]
  all = b.data_for_all
  all.each do |k,v|
    puts "Data for day #{k}"
    t = ApiResponseModel.new(v).summary
    puts "  average air_temp = #{t["air_temp"]["avg"]}"
  end
  exit
end

if options[:userid] and options[:date]
  raw = b.data_for_day(options[:date])
elsif options[:token] and options[:date]
  raw = b.fetch_activities_for_day(options[:date], options[:token])
else
  raw = $stdin.read
end

if options[:csv]
  m = ApiResponseModel.new(raw)
  lines = samples_to_csv(m.samples_by_minute)
  puts lines.join("\n")
else
  puts raw
end
